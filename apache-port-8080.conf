# Apache VirtualHost Configuration for Port 8080
# This works with Caddy as the front-facing HTTPS server
# Deploy to: /etc/apache2/sites-available/pos-8080.conf

<VirtualHost *:8080>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    # POS Laravel Application Alias
    Alias /vpos/hmart /var/www/html/VPOS/public

    <Directory /var/www/html/VPOS/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Trust proxy headers from Caddy
        # This ensures Laravel sees the correct HTTPS scheme and client IP
        <IfModule mod_remoteip.c>
            RemoteIPHeader X-Real-IP
            RemoteIPTrustedProxy 127.0.0.1
        </IfModule>
    </Directory>

    # Block sensitive directories
    <Directory /var/www/html/VPOS/storage>
        Require all denied
    </Directory>

    <Directory /var/www/html/VPOS/bootstrap/cache>
        Require all denied
    </Directory>

    <Directory /var/www/html/VPOS/.git>
        Require all denied
    </Directory>

    # Block .env files
    <FilesMatch "^\.env">
        Require all denied
    </FilesMatch>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/pos-error.log
    CustomLog ${APACHE_LOG_DIR}/pos-access.log combined
    LogLevel warn
</VirtualHost>

# INSTALLATION INSTRUCTIONS:
#
# 1. Deploy this file:
#    sudo cp apache-port-8080.conf /etc/apache2/sites-available/pos-8080.conf
#
# 2. Enable required Apache modules:
#    sudo a2enmod rewrite
#    sudo a2enmod headers
#    sudo a2enmod alias
#    sudo a2enmod remoteip
#
# 3. Test Apache configuration:
#    sudo apache2ctl configtest
#
# 4. Enable this site:
#    sudo a2ensite pos-8080.conf
#
# 5. Reload Apache:
#    sudo systemctl reload apache2
#
# 6. Verify Apache is listening on port 8080:
#    sudo netstat -tlnp | grep :8080
#
# 7. Test local access:
#    curl http://127.0.0.1:8080/vpos/hmart
#
# NOTES:
# - Apache listens on port 8080 (not 443)
# - Caddy handles HTTPS on port 443 and reverse proxies to Apache
# - mod_remoteip ensures Laravel sees real client IP, not 127.0.0.1
# - X-Forwarded-* headers from Caddy are trusted
